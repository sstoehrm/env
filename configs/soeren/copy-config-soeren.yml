---
# Copy Soeren's configuration files to their target locations
# Run with: ansible-playbook configs/soeren/copy-config-soeren.yml

- name: Copy Soeren's Configurations
  hosts: localhost
  vars:
    config_files:
      # VSCode settings
      - source: "vscode/settings.json"
        target: "{{ user_home }}/.config/Code/User/settings.json"
        create_backup: yes
      # VSCode keybindings
      - source: "vscode/keybindings.json"
        target: "{{ user_home }}/.config/Code/User/keybindings.json"
        create_backup: yes
      # Zellij configuration
      - source: "zellij/config.kdl"
        target: "{{ user_home }}/.config/zellij/config.kdl"
        create_backup: yes

  tasks:
    - name: Gather facts
      setup:

    - name: Set user variables
      set_fact:
        user: "{{ ansible_facts['user_id'] }}"
        user_home: "{{ ansible_facts['env']['HOME'] }}"

    - name: Set configs base path
      set_fact:
        configs_base: "{{ playbook_dir }}"

    - name: Create target directories for config files
      file:
        path: "{{ item.target | dirname }}"
        state: directory
        mode: '0755'
        owner: "{{ user }}"
      loop: "{{ config_files }}"
      become: yes
      become_method: sudo

    - name: Check if source config files exist
      stat:
        path: "{{ configs_base }}/{{ item.source }}"
      loop: "{{ config_files }}"
      register: source_files_check

    - name: Copy configuration files
      copy:
        src: "{{ configs_base }}/{{ item.item.source }}"
        dest: "{{ item.item.target }}"
        owner: "{{ user }}"
        mode: '0644'
        backup: "{{ item.item.create_backup | default(true) }}"
      loop: "{{ source_files_check.results }}"
      when: item.stat.exists
      become: yes
      become_method: sudo

    - name: List missing configuration files
      debug:
        msg: "Configuration file not found: {{ item.item.source }}"
      loop: "{{ source_files_check.results }}"
      when: not item.stat.exists
