---
- name: LazyVim
  hosts: localhost

  tasks:
    - name: Gather facts
      setup:

    - name: Set user variables
      set_fact:
        user: "{{ ansible_facts['user_id'] }}"
        user_home: "{{ ansible_facts['env']['HOME'] }}"
    - name: Check if LazyVim is already installed
      stat:
        path: "{{ user_home }}/.config/nvim"
      register: lazyvim_check
      changed_when: false

    - name: Display message if LazyVim is already installed
      debug:
        msg: "LazyVim is already installed at {{ user_home }}/.config/nvim. Skipping installation to preserve existing configuration."
      when: lazyvim_check.stat.exists

    - name: Clone LazyVim starter configuration
      git:
        repo: 'https://github.com/LazyVim/starter'
        dest: "{{ user_home }}/.config/nvim"
        depth: 1
      when: not lazyvim_check.stat.exists

    - name: Remove .git folder from LazyVim config
      file:
        path: "{{ user_home }}/.config/nvim/.git"
        state: absent
      when: not lazyvim_check.stat.exists

    - name: Fix nvim cache directory permissions
      file:
        path: "{{ user_home }}/.cache/nvim"
        state: directory
        mode: '0755'
        owner: "{{ user }}"
        group: "{{ user }}"
        recurse: yes
