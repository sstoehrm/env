---
- name: Odin
  hosts: localhost
  vars:
    user: 'soeren'
    user_home: '/home/soeren'
    local_bin: '{{ user_home }}/.local/bin'

  tasks:
    - name: Ensure ~/.local/bin directory exists
      file:
        path: "{{ local_bin }}"
        state: directory
        mode: '0755'

    - name: Check if Odin is already installed
      stat:
        path: "{{ local_bin }}/odin"
      register: odin_check
      changed_when: false

    - name: Get latest Odin release version
      uri:
        url: https://api.github.com/repos/odin-lang/Odin/releases/latest
        return_content: yes
      register: odin_release
      when: not odin_check.stat.exists

    - name: Download latest Odin binary
      get_url:
        url: "https://github.com/odin-lang/Odin/releases/download/{{ odin_release.json.tag_name }}/odin-linux-amd64-{{ odin_release.json.tag_name }}.tar.gz"
        dest: /tmp/odin-latest.tar.gz
      when: not odin_check.stat.exists

    - name: Extract Odin binary
      unarchive:
        src: /tmp/odin-latest.tar.gz
        dest: "{{ local_bin }}"
        remote_src: yes
        extra_opts: [--strip-components=1]
      when: not odin_check.stat.exists

    - name: Make Odin executable
      file:
        path: "{{ local_bin }}/odin"
        mode: '0755'
      when: not odin_check.stat.exists

    - name: Clean up downloaded files
      file:
        path: /tmp/odin-latest.tar.gz
        state: absent
      when: not odin_check.stat.exists
