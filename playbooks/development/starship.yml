---
- name: Starship
  hosts: localhost
  vars:
    user: 'soeren'
    user_home: '/home/soeren'
    config_dir: '{{ user_home }}/.config'

  tasks:
    - name: Check if Starship is already installed
      command: which starship
      register: starship_check
      changed_when: false
      failed_when: false

    - name: Download Starship installer
      get_url:
        url: https://starship.rs/install.sh
        dest: /tmp/starship-install.sh
        mode: '0755'
      when: starship_check.rc != 0

    - name: Install Starship
      become: yes
      become_method: sudo
      shell: /tmp/starship-install.sh -y
      when: starship_check.rc != 0

    - name: Clean up installer script
      file:
        path: /tmp/starship-install.sh
        state: absent
      when: starship_check.rc != 0

    - name: Check if Starship is already initialized in .bashrc
      shell: grep -q 'starship init bash' {{ user_home }}/.bashrc
      register: bashrc_check
      changed_when: false
      failed_when: false

    - name: Add Starship initialization to .bashrc
      lineinfile:
        path: "{{ user_home }}/.bashrc"
        line: 'eval "$(starship init bash)"'
        create: yes
      when: bashrc_check.rc != 0

    - name: Ensure ~/.config directory exists
      file:
        path: "{{ config_dir }}"
        state: directory
        mode: '0755'

    - name: Apply bracketed-segments preset
      command: starship preset bracketed-segments -o {{ config_dir }}/starship.toml
      args:
        creates: "{{ config_dir }}/starship.toml"

    - name: Verify Starship installation
      command: starship --version
      register: starship_version
      changed_when: false

    - name: Display Starship version
      debug:
        msg: "{{ starship_version.stdout }}"
