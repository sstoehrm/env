---
- name: Starship
  hosts: localhost
  vars:
    user: 'soeren'
    user_home: '/home/soeren'
    config_dir: '{{ user_home }}/.config'

  tasks:
    - name: Check if Starship is already installed
      command: which starship
      register: starship_check
      changed_when: false
      failed_when: false

    - name: Download Starship installer
      get_url:
        url: https://starship.rs/install.sh
        dest: /tmp/starship-install.sh
        mode: '0755'
      when: starship_check.rc != 0

    - name: Install Starship
      become: yes
      become_method: sudo
      shell: /tmp/starship-install.sh -y
      when: starship_check.rc != 0

    - name: Clean up installer script
      file:
        path: /tmp/starship-install.sh
        state: absent
      when: starship_check.rc != 0

    - name: Check if Starship is already initialized in .bashrc
      shell: grep -q 'starship init bash' {{ user_home }}/.bashrc
      register: bashrc_check
      changed_when: false
      failed_when: false

    - name: Add Starship initialization to .bashrc
      lineinfile:
        path: "{{ user_home }}/.bashrc"
        line: 'eval "$(starship init bash)"'
        create: yes
      when: bashrc_check.rc != 0

    - name: Ensure ~/.config directory exists
      file:
        path: "{{ config_dir }}"
        state: directory
        mode: '0755'

    - name: Check if Starship config exists
      stat:
        path: "{{ config_dir }}/starship.toml"
      register: starship_config_check

    - name: Create default Starship configuration
      copy:
        dest: "{{ config_dir }}/starship.toml"
        content: |
          # Starship configuration
          # Get editor completions based on the config schema
          "$schema" = 'https://starship.rs/config-schema.json'

          # Inserts a blank line between shell prompts
          add_newline = true

          # Timeout for commands executed by starship (in milliseconds)
          command_timeout = 500

          # Format configuration
          format = """
          [â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>](bold green)
          [â”‚](bold green)$directory$git_branch$git_status
          [â””â”€>](bold green) """

          [character]
          success_symbol = "[âœ](bold green)"
          error_symbol = "[âœ](bold red)"

          [directory]
          truncation_length = 3
          truncate_to_repo = true
          style = "bold cyan"

          [git_branch]
          symbol = " "
          style = "bold purple"

          [git_status]
          style = "bold yellow"
          conflicted = "ğŸ³"
          up_to_date = ""
          untracked = "ğŸ¤·"
          ahead = "â‡¡${count}"
          diverged = "â‡•â‡¡${ahead_count}â‡£${behind_count}"
          behind = "â‡£${count}"
          stashed = "ğŸ“¦"
          modified = "!"
          staged = '[++\($count\)](green)'
          renamed = "Â»"
          deleted = "âœ˜"

          [nodejs]
          symbol = " "

          [python]
          symbol = " "

          [rust]
          symbol = " "

          [java]
          symbol = " "

          [docker_context]
          symbol = " "
        mode: '0644'
      when: not starship_config_check.stat.exists

    - name: Verify Starship installation
      command: starship --version
      register: starship_version
      changed_when: false

    - name: Display Starship version
      debug:
        msg: "{{ starship_version.stdout }}"
