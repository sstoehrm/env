---
- name: Zellij Configuration
  hosts: localhost

  tasks:
    - name: Gather facts
      setup:

    - name: Set user variables
      set_fact:
        user: "{{ ansible_facts['user_id'] }}"
        user_home: "{{ ansible_facts['env']['HOME'] }}"

    - name: Ensure Zellij config directory exists
      file:
        path: "{{ user_home }}/.config/zellij"
        state: directory
        mode: '0755'

    - name: Create Zellij configuration
      copy:
        dest: "{{ user_home }}/.config/zellij/config.kdl"
        content: |
          // Zellij configuration file

          // Set the default shell
          default_shell "bash"

          // Enable mouse support
          mouse_mode true

          // Enable pane frames
          pane_frames true

          // Simplified UI
          simplified_ui false

          // Theme
          theme "default"

          // Copy to clipboard
          copy_command "xclip -selection clipboard"

          // Scrollback buffer
          scroll_buffer_size 10000

          // Copy on select
          copy_on_select true

          // Default mode
          default_mode "normal"

          // Keybindings
          keybinds {
              normal {
                  // Unbind Ctrl+q (quit)
                  unbind "Ctrl q"
              }
              shared_except "locked" {
                  bind "Alt h" { MoveFocus "Left"; }
                  bind "Alt l" { MoveFocus "Right"; }
                  bind "Alt j" { MoveFocus "Down"; }
                  bind "Alt k" { MoveFocus "Up"; }
              }
          }
        mode: '0644'

    - name: Add Zellij autostart to .bashrc
      blockinfile:
        path: "{{ user_home }}/.bashrc"
        marker: "# {mark} ZELLIJ AUTOSTART"
        block: |
          # Auto-start Zellij if not already running
          if command -v zellij &> /dev/null && [ -z "$ZELLIJ" ]; then
            zellij attach -c main
          fi
        create: yes
        mode: '0644'
