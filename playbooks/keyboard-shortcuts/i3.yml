---
# Keyboard shortcuts for i3 window manager
# Works on: Fedora i3 Spin, any i3 installation
# Run with: ansible-playbook playbooks/keyboard-shortcuts/i3.yml

- name: i3 Keyboard Shortcuts
  hosts: localhost
  vars:
    user: 'soeren'
    user_home: '/home/soeren'

  tasks:
    - name: Detect distribution
      set_fact:
        is_ubuntu: "{{ ansible_facts['distribution'] == 'Ubuntu' or ansible_facts['distribution'] == 'Debian' }}"
        is_fedora: "{{ ansible_facts['distribution'] == 'Fedora' or ansible_facts['distribution'] == 'RedHat' or ansible_facts['distribution'] == 'CentOS' }}"

    - name: Set terminal for i3 based on distribution
      set_fact:
        terminal: "{{ 'urxvt' if is_fedora else 'gnome-terminal' }}"

    - name: Set browser command based on distribution
      set_fact:
        browser_cmd: "{{ 'chromium' if is_ubuntu else 'flatpak run org.chromium.Chromium' if is_fedora else 'chromium' }}"

    - name: Set file manager
      set_fact:
        file_manager: 'nautilus'

    - name: Display environment
      debug:
        msg:
          - "Configuring i3 keyboard shortcuts"
          - "Distribution: {{ ansible_facts['distribution'] }}"
          - "Terminal: {{ terminal }}"
          - "Browser: {{ browser_cmd }}"
          - "File Manager: {{ file_manager }}"

    - name: Detect i3 config location
      stat:
        path: "{{ item }}"
      loop:
        - "{{ user_home }}/.config/i3/config"
        - "{{ user_home }}/.i3/config"
      register: i3_config_check

    - name: Set i3 config path
      set_fact:
        i3_config_path: "{{ i3_config_check.results | selectattr('stat.exists') | map(attribute='item') | first | default(user_home + '/.config/i3/config') }}"

    - name: Create i3 config directory if needed
      file:
        path: "{{ user_home }}/.config/i3"
        state: directory
        mode: '0755'
      when: i3_config_path == user_home + '/.config/i3/config'

    - name: Backup existing i3 config
      copy:
        src: "{{ i3_config_path }}"
        dest: "{{ i3_config_path }}.backup.{{ ansible_date_time.epoch }}"
        remote_src: yes
      when: i3_config_check.results | selectattr('stat.exists') | list | length > 0

    - name: Check if i3 config exists
      stat:
        path: "{{ i3_config_path }}"
      register: i3_config_stat

    - name: Create basic i3 config if it doesn't exist
      copy:
        dest: "{{ i3_config_path }}"
        content: |
          # i3 config file (v4)
          # Please see https://i3wm.org/docs/userguide.html for a complete reference!

          set $mod Mod4

          # Font for window titles
          font pango:monospace 8

          # Use Mouse+$mod to drag floating windows
          floating_modifier $mod

          # Start a terminal
          bindsym $mod+Return exec {{ terminal }}

          # Kill focused window
          bindsym $mod+Shift+q kill

          # Start dmenu (program launcher)
          bindsym $mod+d exec --no-startup-id dmenu_run

          # Change focus
          bindsym $mod+j focus left
          bindsym $mod+k focus down
          bindsym $mod+l focus up
          bindsym $mod+semicolon focus right

          # Alternatively, cursor keys
          bindsym $mod+Left focus left
          bindsym $mod+Down focus down
          bindsym $mod+Up focus up
          bindsym $mod+Right focus right

          # Move focused window
          bindsym $mod+Shift+j move left
          bindsym $mod+Shift+k move down
          bindsym $mod+Shift+l move up
          bindsym $mod+Shift+semicolon move right

          # Alternatively, cursor keys
          bindsym $mod+Shift+Left move left
          bindsym $mod+Shift+Down move down
          bindsym $mod+Shift+Up move up
          bindsym $mod+Shift+Right move right

          # Split orientation
          bindsym $mod+h split h
          bindsym $mod+v split v

          # Enter fullscreen mode
          bindsym $mod+f fullscreen toggle

          # Change container layout
          bindsym $mod+s layout stacking
          bindsym $mod+w layout tabbed
          bindsym $mod+e layout toggle split

          # Toggle tiling / floating
          bindsym $mod+Shift+space floating toggle

          # Change focus between tiling / floating windows
          bindsym $mod+space focus mode_toggle

          # Reload the configuration file
          bindsym $mod+Shift+c reload
          # Restart i3 inplace
          bindsym $mod+Shift+r restart
          # Exit i3
          bindsym $mod+Shift+e exec "i3-nagbar -t warning -m 'Exit i3?' -B 'Yes' 'i3-msg exit'"

          # Resize window mode
          mode "resize" {
                  bindsym j resize shrink width 10 px or 10 ppt
                  bindsym k resize grow height 10 px or 10 ppt
                  bindsym l resize shrink height 10 px or 10 ppt
                  bindsym semicolon resize grow width 10 px or 10 ppt

                  bindsym Left resize shrink width 10 px or 10 ppt
                  bindsym Down resize grow height 10 px or 10 ppt
                  bindsym Up resize shrink height 10 px or 10 ppt
                  bindsym Right resize grow width 10 px or 10 ppt

                  bindsym Return mode "default"
                  bindsym Escape mode "default"
                  bindsym $mod+r mode "default"
          }

          bindsym $mod+r mode "resize"

          # Start i3bar
          bar {
                  status_command i3status
          }
        mode: '0644'
      when: not i3_config_stat.stat.exists

    - name: Remove old Omarchy-style keybindings from i3 config
      lineinfile:
        path: "{{ i3_config_path }}"
        regexp: "{{ item }}"
        state: absent
      loop:
        - '^bindsym \$mod\+Return exec.*# Omarchy:.*'
        - '^bindsym \$mod\+Shift\+b exec.*# Omarchy:.*'
        - '^bindsym \$mod\+Shift\+f exec.*# Omarchy:.*'
        - '^bindsym \$mod\+Shift\+n exec.*# Omarchy:.*'
        - '^bindsym \$mod\+Shift\+g exec.*# Omarchy:.*'
        - '^bindsym \$mod\+w kill.*# Omarchy:.*'
        - '^bindsym \$mod\+f fullscreen.*# Omarchy:.*'
        - '^bindsym \$mod\+[1-4] workspace.*# Omarchy:.*'
        - '^bindsym \$mod\+Shift\+[1-4] move container.*# Omarchy:.*'

    - name: Add Omarchy-style keybindings to i3 config
      blockinfile:
        path: "{{ i3_config_path }}"
        marker: "# {mark} OMARCHY KEYBINDINGS"
        block: |
          # Omarchy-style keyboard shortcuts
          # Using {{ terminal }} as terminal emulator

          # Terminal launcher (Mod4+Return)
          bindsym $mod+Return exec {{ terminal }}

          # Browser launcher (Mod4+Shift+B)
          bindsym $mod+Shift+b exec {{ browser_cmd }}

          # File manager (Mod4+Shift+F)
          bindsym $mod+Shift+f exec {{ file_manager }}

          # Neovim (Mod4+Shift+N)
          bindsym $mod+Shift+n exec {{ terminal }} -e nvim

          # Lazygit (Mod4+Shift+G)
          bindsym $mod+Shift+g exec {{ terminal }} -e {{ user_home }}/.local/bin/lazygit

          # Close window (Mod4+W)
          bindsym $mod+w kill

          # Toggle fullscreen (Mod4+F)
          bindsym $mod+f fullscreen toggle

          # Switch workspaces (Mod4+1/2/3/4)
          bindsym $mod+1 workspace number 1
          bindsym $mod+2 workspace number 2
          bindsym $mod+3 workspace number 3
          bindsym $mod+4 workspace number 4

          # Move window to workspace (Mod4+Shift+1/2/3/4)
          bindsym $mod+Shift+1 move container to workspace number 1
          bindsym $mod+Shift+2 move container to workspace number 2
          bindsym $mod+Shift+3 move container to workspace number 3
          bindsym $mod+Shift+4 move container to workspace number 4

    - name: i3 shortcuts configured
      debug:
        msg:
          - "i3 keyboard shortcuts configured successfully"
          - "Config location: {{ i3_config_path }}"
          - "Terminal: {{ terminal }}"
          - "Backup created: {{ i3_config_path }}.backup.{{ ansible_date_time.epoch }}"
          - ""
          - "Shortcuts:"
          - "  Mod4+Return         → Terminal ({{ terminal }})"
          - "  Mod4+Shift+B        → Browser"
          - "  Mod4+Shift+F        → File Manager"
          - "  Mod4+Shift+N        → Neovim"
          - "  Mod4+Shift+G        → Lazygit"
          - "  Mod4+W              → Close window"
          - "  Mod4+F              → Toggle fullscreen"
          - "  Mod4+1/2/3/4        → Switch to workspace 1/2/3/4"
          - "  Mod4+Shift+1/2/3/4  → Move window to workspace 1/2/3/4"
          - ""
          - "Reload i3 with: Mod4+Shift+R"
